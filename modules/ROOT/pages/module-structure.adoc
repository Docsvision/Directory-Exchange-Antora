= Структура модуля

[#architecture]
== Общее описание архитектуры

Основу архитектуры решения представляет организация территориально-распределенных серверов {dv} по принципу _Публикатор -- Подписчик_.

_Публикатор_ -- сервер {dv}, на котором производится накопление изменений и их отправка серверам-подписчикам.

.Архитектура модуля
image::admin:module-structure.png[Архитектура модуля]

Каждый сервер {dv} может выступать как публикатором, так и подписчиком, что позволяет обеспечить двустороннюю синхронизацию измененных данных.

.Принципы работы:
. Для накопления изменений на сервере-публикаторе производится включение режима отслеживания изменений таблиц на уровне БД.
. Сбор накопленных изменений производится специальным приложением или службой в случае фоновой синхронизации или пользовательской программой в случае принудительной синхронизации. Это же приложение и производит отправку измененных данных на сервера-подписчики.
. Отправка изменений серверам-подписчикам производится путем прямого подключения к удаленному серверу-подписчику и вызова методов специального серверного расширения.

Для исключения повторной отправки изменений на сервер, на котором эти изменения порождены, к данным добавляется идентификатор сервера {dv}, на котором были созданы или изменены записи: при создании строки секции идентификатор текущего сервера сохраняется в системное поле `OwnerServerID`, при изменении строки секции -- в системное поле `ChangeServerID`.

В момент синхронизации серверу-подписчику отправляются все измененные данные, кроме тех, которые были изменены на сервере-подписчике.

[#components]
== Компоненты системы

.Компоненты системы
image::admin:system-components.png[Компоненты системы]

При установке модуля синхронизации производится установка и настройка следующих компонентов:

* Библиотека карточек "Распределенные базы" со справочником "Справочник распределенных баз". Данный справочник содержит настройки сценариев синхронизации, настройки расписания синхронизации.
* Программа "Консоль настроек репликации справочников". Данная программа предназначена для настройки сценариев синхронизации, настройки расписания синхронизации, настройки, установки и запуска сервиса репликации справочников, запуска синхронизации в ручном режиме, мониторинга журнала синхронизации.
* База данных модуля репликации. Указанная база устанавливается на выбранном в "Консоль настроек репликации справочников" MS SQL сервере. База предназначена для хранения журнала синхронизации, а также для хранения служебной информации.
* Настройка отслеживания изменений таблиц базы {dv}. При выполнении настроек синхронизации программа "Консоль настроек репликации справочников" включает в базе данных {dv} режим отслеживания изменений таблиц, связанных с синхронизируемыми карточками.
* Сервис репликации справочников. Данный сервис предназначен для проведения синхронизации по указанному в настройках расписанию в фоновом режиме.
* Серверное расширение. Предназначено для выполнения импорта синхронизируемых данных на сервере-подписчике.

[#process-description]
== Описание процесса синхронизации

.Описание процесса синхронизации
image::admin:synchronization-process.png[Описание процесса синхронизации]

.Процесс синхронизации данных состоит из следующих шагов:
. При старте сервиса репликации на сервере-публикаторе производится чтение карточки "Справочник распределенных баз" и анализ расписания обмена каждого из сценариев. На основе анализа формируется задание на синхронизацию по каждому сценарию для каждого сервера-подписчика. Сформированные задания помещаются в очередь с вычисленным на основе расписания временем выполнения.
. В заданное время производится выполнение процедуры синхронизации по указанному сценарию для указанного сервера-подписчика. При этом:
.. Из справочника распределенных баз анализируется состав метаданных, включенных в сценарий синхронизации, определяется набор таблиц, которые должны быть синхронизированы (см. xref:admin:settings-data-composition.adoc[Настройка состава синхронизируемых данных]).
.. Для каждой таблицы производится считывание идентификаторов тех записей, которые были изменены с момента предыдущей синхронизации. Если последняя синхронизированная версия таблицы меньше минимально доступной версии таблицы в БД или синхронизация производится первый раз и у сервера-публикатора установлен режим "Требуется полная инициализация", то измененными считаются все записи таблицы.
.. Для каждой измененной записи производится экспорт в XML стандартными средствами {dv}.
.. Производится вызов методом серверного расширения на сервере-подписчике с передачей данных в формате XML.
.. Информация о синхронизации объекта фиксируется в xref:admin:synchronization-diagnostics.adoc#synch-log[Журнале синхронизированных данных].
.. В случае разрыва соединения с сервером-подписчиком сервис производит переподключение к удаленному серверу. Количество попыток переподключения и интервал между попытками указывается в настройках сервера-публикатора.
.. По завершении синхронизации для указанного сервера подписчика фиксируется текущий номер версии таблиц, начиная с которой будет произведена синхронизация в следующей итерации обмена.
.. Если синхронизация прошла неуспешно (отсутствует соединение с удаленным сервером), версия последней синхронизации для данного сервера-подписчика не меняется, информация об ошибке фиксируется в журнале приложений Windows, см. xref:admin:synchronization-diagnostics.adoc#replication-log[Журнал Сервиса репликации справочников].
. По завершении этапа синхронизации производится расчет нового времени выполнения на основе расписания обмена и постановка задания синхронизации в очередь.

[#conflicts]
== Разрешение конфликтов

При синхронизации данных на разных серверах могут возникать конфликты, связанные с тем, что на разных площадках в одни и те же данные вносятся разные изменения в рамках одного цикла синхронизации.

Данные конфликты должны быть решены на уровне установки соответствующих прав на данные, участвующие в синхронизации. Например, можно установить запрет на редактирование конкретного справочника пользователям подчиненного филиала, работающим в системе на территориально удаленном сервере.

Кроме этого, система {dv} поддерживает механизм разграничения прав доступа в зависимости от того, какой из серверов является владельцем той или иной записи:

* Если в схеме карточки для секции установлен признак "Не редактировать строки с иного сервера", то изменить запись можно только на том сервере, на котором эта запись была создана;
* Если в схеме карточки для секции установлен признак "Не изменять дочерние строки с иного сервера", то добавить или изменить подчиненные строки можно только на том сервере, на котором эта запись была создана.

Информация о том, на каком сервере была создана запись, хранится в служебном поле любой секции "OwnerServerID". Для смены владельца записи необходимо заменить идентификатор в данном поле на идентификатор того сервера, который должен стать владельцем записи.
